<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8">
<title>index.html</title>
<style>body{max-width:70ch;margin:3rem auto;line-height:1.7}</style>
<body>
<p>&lt;!DOCTYPE html&gt;<br>&lt;html lang=&quot;zh-CN&quot;&gt;<br>&lt;head&gt;<br>  &lt;meta charset=&quot;utf-8&quot; /&gt;<br>  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;<br>  &lt;title&gt;Mic Waveform · Web 实时波形/频谱&lt;/title&gt;<br>  &lt;style&gt;<br>    :root {<br>      --bg: #0b0e11;<br>      --panel: #12161a;<br>      --text: #dfe6ee;<br>      --muted: #8894a3;<br>      --accent: #8ab4ff;<br>      --grid: #22303c;<br>      --border: #1b2229;<br>    }<br>    * { box-sizing: border-box; }<br>    body {<br>      margin: 0; background: var(--bg); color: var(--text);<br>      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, PingFang SC, Noto Sans SC, &quot;Microsoft YaHei&quot;, sans-serif;<br>    }<br>    header {<br>      padding: 16px 20px; border-bottom: 1px solid var(--border);<br>      display: flex; align-items: center; gap: 14px; flex-wrap: wrap;<br>      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));<br>    }<br>    h1 { font-size: 18px; margin: 0; font-weight: 600; letter-spacing: .2px; }<br>    .tag { color: var(--muted); font-size: 12px; }<br>    .spacer { flex: 1; }<br>    .ctrl {<br>      display: inline-flex; align-items: center; gap: 8px; background: var(--panel);<br>      border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;<br>    }<br>    select, button {<br>      background: #0e1318; color: var(--text); border: 1px solid var(--border);<br>      padding: 8px 10px; border-radius: 10px; font-size: 14px;<br>    }<br>    button { cursor: pointer; }<br>    button[disabled] { opacity: .6; cursor: not-allowed; }</p>
<p>    main { padding: 16px; display: grid; gap: 16px; grid-template-columns: 1fr; }<br>    .card {<br>      background: var(--panel); border: 1px solid var(--border); border-radius: 16px;<br>      padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.25);<br>    }<br>    .card h2 { margin: 6px 6px 10px; font-size: 14px; color: var(--muted); font-weight: 600; }<br>    .canvas-wrap { position: relative; height: 46vh; max-height: 520px; min-height: 260px; }<br>    canvas { width: 100%; height: 100%; display: block; border-radius: 12px; background: #0a0f14; }<br>    .status { padding: 10px 16px; font-size: 12px; color: var(--muted); }<br>    footer { padding: 10px 16px; color: var(--muted); font-size: 12px; border-top: 1px solid var(--border); }<br>    @media (min-width: 1100px) { main { grid-template-columns: 1fr 1fr; } }<br>  &lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>  &lt;header&gt;<br>    &lt;div&gt;<br>      &lt;h1&gt;Mic Waveform · Web&lt;/h1&gt;<br>      &lt;div class=&quot;tag&quot;&gt;实时波形 / 频谱 · 可调时间窗 · 浏览器端&lt;/div&gt;<br>    &lt;/div&gt;<br>    &lt;div class=&quot;spacer&quot;&gt;&lt;/div&gt;<br>    &lt;div class=&quot;ctrl&quot;&gt;<br>      &lt;label for=&quot;win&quot;&gt;时间窗&lt;/label&gt;<br>      &lt;select id=&quot;win&quot;&gt;<br>        &lt;option value=&quot;0.020&quot;&gt;20 ms&lt;/option&gt;<br>        &lt;option value=&quot;0.050&quot; selected&gt;50 ms&lt;/option&gt;<br>        &lt;option value=&quot;0.100&quot;&gt;100 ms&lt;/option&gt;<br>        &lt;option value=&quot;0.200&quot;&gt;200 ms&lt;/option&gt;<br>        &lt;option value=&quot;0.500&quot;&gt;500 ms&lt;/option&gt;<br>        &lt;option value=&quot;1&quot;&gt;1 s&lt;/option&gt;<br>        &lt;option value=&quot;2&quot;&gt;2 s&lt;/option&gt;<br>        &lt;option value=&quot;5&quot;&gt;5 s&lt;/option&gt;<br>      &lt;/select&gt;<br>      &lt;button id=&quot;btn&quot;&gt;开始采集&lt;/button&gt;<br>    &lt;/div&gt;<br>  &lt;/header&gt;</p>
<p>  &lt;main&gt;<br>    &lt;section class=&quot;card&quot;&gt;<br>      &lt;h2&gt;时间域 · Waveform&lt;/h2&gt;<br>      &lt;div class=&quot;canvas-wrap&quot;&gt;&lt;canvas id=&quot;cWave&quot;&gt;&lt;/canvas&gt;&lt;/div&gt;<br>    &lt;/section&gt;<br>    &lt;section class=&quot;card&quot;&gt;<br>      &lt;h2&gt;频率域 · Spectrum&lt;/h2&gt;<br>      &lt;div class=&quot;canvas-wrap&quot;&gt;&lt;canvas id=&quot;cSpec&quot;&gt;&lt;/canvas&gt;&lt;/div&gt;<br>    &lt;/section&gt;<br>  &lt;/main&gt;</p>
<p>  &lt;div class=&quot;status&quot; id=&quot;status&quot;&gt;状态：就绪。提示：麦克风需要 HTTPS 或 localhost。&lt;/div&gt;<br>  &lt;footer&gt;<br>    提醒：首次启动需要点击“开始采集”并允许麦克风权限；如无声，检查系统输入设备是否正确、浏览器是否被静音。<br>  &lt;/footer&gt;</p>
<p>&lt;script&gt;<br>(() =&gt; {<br>  const el = (id) =&gt; document.getElementById(id);<br>  const $btn = el(&#x27;btn&#x27;);<br>  const $win = el(&#x27;win&#x27;);<br>  const $status = el(&#x27;status&#x27;);<br>  const $cWave = el(&#x27;cWave&#x27;);<br>  const $cSpec = el(&#x27;cSpec&#x27;);<br>  const gw = $cWave.getContext(&#x27;2d&#x27;);<br>  const gs = $cSpec.getContext(&#x27;2d&#x27;);<br>  let running = false;</p>
<p>  // Audio context &amp; graph<br>  let ac = null;<br>  let analyser = null; // For spectrum only<br>  let port = null;     // Worklet port for raw samples<br>  let sampleRate = 48000;</p>
<p>  // Ring buffer for waveform up to 5s (mono)<br>  let winSec = parseFloat($win.value);<br>  let ring = new Float32Array(Math.max(1, Math.floor(winSec * sampleRate)));<br>  let wptr = 0, filled = false;</p>
<p>  function resizeRing(seconds) {<br>    winSec = seconds;<br>    const newN = Math.max(1, Math.floor(winSec * sampleRate));<br>    const out = new Float32Array(newN);<br>    // take last newN samples from existing ring<br>    const current = readAll();<br>    const slice = current.length &gt; newN ? current.subarray(current.length - newN) : current;<br>    out.set(slice, newN - slice.length);<br>    ring = out; wptr = newN; filled = slice.length === newN;<br>  }</p>
<p>  function writeRing(frame) {<br>    const n = frame.length;<br>    if (n &gt;= ring.length) {<br>      ring.set(frame.subarray(n - ring.length));<br>      wptr = 0; filled = true; return;<br>    }<br>    const end = wptr + n;<br>    if (end &lt; ring.length) {<br>      ring.set(frame, wptr); wptr = end;<br>    } else {<br>      const p1 = ring.length - wptr;<br>      ring.set(frame.subarray(0, p1), wptr);<br>      ring.set(frame.subarray(p1), 0);<br>      wptr = (end % ring.length); filled = true;<br>    }<br>  }</p>
<p>  function readAll() {<br>    if (!filled) return ring.subarray(0, wptr);<br>    const idx = new Float32Array(ring.length);<br>    // reconstruct ordered view<br>    const out = new Float32Array(ring.length);<br>    out.set(ring.subarray(wptr));<br>    out.set(ring.subarray(0, wptr), ring.length - wptr);<br>    return out;<br>  }</p>
<p>  // Drawing helpers<br>  function clear(ctx) {<br>    const c = ctx.canvas; ctx.clearRect(0, 0, c.width, c.height);<br>    ctx.fillStyle = &#x27;#0a0f14&#x27;; ctx.fillRect(0,0,c.width,c.height);<br>  }<br>  function drawGrid(ctx, xTicks=8, yTicks=4) {<br>    const {width:W, height:H} = ctx.canvas;<br>    ctx.strokeStyle = &#x27;#22303c&#x27;; ctx.lineWidth = 1;<br>    ctx.globalAlpha = 0.9; ctx.beginPath();<br>    for (let i=1;i&lt;xTicks;i++){ const x = (W*i)/xTicks; ctx.moveTo(x,0); ctx.lineTo(x,H);} <br>    for (let j=1;j&lt;yTicks;j++){ const y = (H*j)/yTicks; ctx.moveTo(0,y); ctx.lineTo(W,y);} <br>    ctx.stroke(); ctx.globalAlpha = 1;<br>  }<br>  function drawAxesLabel(ctx, labelL, labelB) {<br>    ctx.fillStyle = &#x27;#8894a3&#x27;; ctx.font = &#x27;12px system-ui, -apple-system, Segoe UI, Roboto&#x27;;<br>    ctx.fillText(labelL, 10, 16);<br>    ctx.fillText(labelB, 10, ctx.canvas.height - 8);<br>  }</p>
<p>  function drawWave() {<br>    const {width:W, height:H} = gw.canvas;<br>    clear(gw); drawGrid(gw, 10, 4); drawAxesLabel(gw, &#x27;Amplitude&#x27;, `Time (last ${winSec.toFixed(3)} s)`);<br>    const y = readAll(); if (!y.length) return;<br>    gw.strokeStyle = &#x27;#8ab4ff&#x27;; gw.lineWidth = 1.5; gw.beginPath();<br>    const N = y.length; const step = Math.max(1, Math.floor(N / W));<br>    // downsample with min/max envelope to preserve peaks<br>    let x = 0; let i = Math.max(0, N - W * step);<br>    const mid = H * 0.5; const scale = H * 0.45; <br>    while (i &lt; N) {<br>      const j = Math.min(i + step, N);<br>      let minv = 1e9, maxv = -1e9;<br>      for (let k=i; k&lt;j; k++){ const v=y[k]; if (v&lt;minv) minv=v; if (v&gt;maxv) maxv=v; }<br>      const y1 = mid - minv * scale; const y2 = mid - maxv * scale;<br>      gw.moveTo(x, y1); gw.lineTo(x, y2);<br>      x += 1; i = j;<br>    }<br>    gw.stroke();<br>  }</p>
<p>  function drawSpec() {<br>    if (!analyser) return;<br>    const {width:W, height:H} = gs.canvas;<br>    clear(gs); drawGrid(gs, 10, 4); drawAxesLabel(gs, &#x27;Magnitude&#x27;, &#x27;Frequency (Hz)&#x27;);<br>    const N = analyser.frequencyBinCount;<br>    const arr = new Float32Array(N);<br>    analyser.getFloatFrequencyData(arr); // dB values<br>    // Normalize to 0..1<br>    let min = Infinity, max = -Infinity;<br>    for (let i=0;i&lt;N;i++){ const v=arr[i]; if (v&lt;min) min=v; if (v&gt;max) max=v; }<br>    const range = (max-min) || 1;<br>    gs.strokeStyle = &#x27;#8ab4ff&#x27;; gs.lineWidth = 1.2; gs.beginPath();<br>    for (let x=0; x&lt;W; x++){<br>      const idx = Math.floor(x * N / W);<br>      const v = (arr[idx]-min)/range; // 0..1<br>      const y = H - v * (H*0.9) - H*0.05;<br>      if (x===0) gs.moveTo(0,y); else gs.lineTo(x,y);<br>    }<br>    gs.stroke();<br>    // Nyquist label<br>    gs.fillStyle = &#x27;#8894a3&#x27;; gs.font = &#x27;12px system-ui, -apple-system, Segoe UI, Roboto&#x27;;<br>    gs.fillText(`FFT Size: ${analyser.fftSize} · Fs: ${Math.round(sampleRate)} Hz · Nyquist: ${Math.round(sampleRate/2)} Hz`, 10, 16);<br>  }</p>
<p>  function fitCanvas(c){<br>    const dpr = Math.max(1, window.devicePixelRatio || 1);<br>    const rect = c.getBoundingClientRect();<br>    const W = Math.max(200, Math.floor(rect.width * dpr));<br>    const H = Math.max(150, Math.floor(rect.height * dpr));<br>    if (c.width !== W || c.height !== H){ c.width = W; c.height = H; }<br>  }</p>
<p>  let rafId = 0;<br>  function loop(){<br>    fitCanvas($cWave); fitCanvas($cSpec);<br>    drawWave(); drawSpec();<br>    rafId = requestAnimationFrame(loop);<br>  }</p>
<p>  async function start(){<br>    if (running) return;<br>    try {<br>      $status.textContent = &#x27;状态：初始化音频…&#x27;;<br>      ac = new (window.AudioContext || window.webkitAudioContext)();<br>      sampleRate = ac.sampleRate || 48000;</p>
<p>      // Create worklet from inline blob (single-file)<br>      const proc = `class MicTap extends AudioWorkletProcessor {\n  constructor(){ super(); }\n  process(inputs){\n    const ch0 = (inputs[0] &amp;&amp; inputs[0][0]) ? inputs[0][0] : null;\n    if (ch0) this.port.postMessage(ch0);\n    return true;\n  }\n}\nregisterProcessor(&#x27;mic-tap&#x27;, MicTap);`;<br>      const blob = new Blob([proc], {type:&#x27;application/javascript&#x27;});<br>      const url = URL.createObjectURL(blob);<br>      await ac.audioWorklet.addModule(url);</p>
<p>      const stream = await navigator.mediaDevices.getUserMedia({audio:true});<br>      const src = ac.createMediaStreamSource(stream);</p>
<p>      // Spectrum<br>      analyser = ac.createAnalyser();<br>      analyser.fftSize = 16384; // power of two &lt;= 32768; good compromise<br>      analyser.smoothingTimeConstant = 0.85;</p>
<p>      // Worklet to capture raw samples for our ring buffer (waveform)<br>      const tap = new AudioWorkletNode(ac, &#x27;mic-tap&#x27;);<br>      port = tap.port; port.onmessage = (ev) =&gt; { writeRing(ev.data); };</p>
<p>      // Wire graph: mic -&gt; [analyser, tap] (not to destination)<br>      src.connect(analyser);<br>      src.connect(tap);</p>
<p>      // Init ring for selected window<br>      resizeRing(parseFloat($win.value));</p>
<p>      // UI<br>      running = true; $btn.textContent = &#x27;停止&#x27;; $status.textContent = `状态：运行中 · 采样率 ${Math.round(sampleRate)} Hz`;<br>      loop();<br>    } catch (err) {<br>      console.error(err);<br>      $status.textContent = &#x27;错误：&#x27; + (err &amp;&amp; err.message ? err.message : err);<br>      running = false; cancelAnimationFrame(rafId);<br>    }<br>  }</p>
<p>  function stop(){<br>    running = false; cancelAnimationFrame(rafId);<br>    if (ac) { ac.close().catch(()=&gt;{}); ac = null; }<br>    analyser = null; port = null;<br>    $btn.textContent = &#x27;开始采集&#x27;;<br>    $status.textContent = &#x27;状态：已停止。&#x27;;<br>  }</p>
<p>  $btn.addEventListener(&#x27;click&#x27;, () =&gt; running ? stop() : start());<br>  $win.addEventListener(&#x27;change&#x27;, () =&gt; {<br>    const s = parseFloat($win.value || &#x27;0.05&#x27;);<br>    resizeRing(s);<br>  });</p>
<p>  // Resize handling<br>  const ro = new ResizeObserver(() =&gt; { if (running) { fitCanvas($cWave); fitCanvas($cSpec); } });<br>  ro.observe($cWave); ro.observe($cSpec);<br>})();<br>&lt;/script&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;</p>

</body></html>